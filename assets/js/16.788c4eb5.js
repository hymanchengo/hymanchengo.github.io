(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{503:function(t,s,a){t.exports=a.p+"assets/img/jvm_arch.ed8606da.png"},546:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"jvm架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jvm架构"}},[t._v("#")]),t._v(" jvm架构")]),t._v(" "),n("h2",{attrs:{id:"架构图"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#架构图"}},[t._v("#")]),t._v(" 架构图")]),t._v(" "),n("p",[n("img",{attrs:{src:a(503),alt:""}})]),t._v(" "),n("h2",{attrs:{id:"类加载子系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#类加载子系统"}},[t._v("#")]),t._v(" 类加载子系统")]),t._v(" "),n("h3",{attrs:{id:"加载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#加载"}},[t._v("#")]),t._v(" 加载")]),t._v(" "),n("p",[t._v("类加载器负责在运行期将类动态加载到jvm。它们是jre的一部分。(在oracle jdk中位于rt.jar下)。类加载器负责和底层文件系统交互，这样jvm就没必要和底层文件系统交互了。\njava类是按需载入内存的，这也是类加载器大展身手的地方。")]),t._v(" "),n("h4",{attrs:{id:"内置类加载器类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内置类加载器类型"}},[t._v("#")]),t._v(" 内置类加载器类型")]),t._v(" "),n("ul",[n("li",[t._v("bootstrap类加载器"),n("br"),t._v("\n它是其他类加载器的父加载器，它是以本地代码编写的。所以"),n("code",[t._v('System.out.println("Classloader of ArrayList:", ArrayList.class.getClassLoader());')]),t._v("输出null。因为bootstrap类加载器不是java类表示的。\n正因此，不同jvm的bootstrap类加载器行为可能会不同。\n"),n("ul",[n("li",[t._v("java类通过"),n("code",[t._v("java.lang.ClassLoader")]),t._v("实例加载，然而类加载器本身也是类，它们由bootstrap类加载器加载")]),t._v(" "),n("li",[t._v("主要负责加载jdk内部类，通常是rt.jar和其他位于"),n("code",[t._v("JAVA_HOME/jre/lib")]),t._v("下的核心库。")])])]),t._v(" "),n("li",[t._v("sun.misc.Launcher$ExtClassLoader扩展类加载器\n"),n("ul",[n("li",[t._v("是bootstrap类加载器的孩子。")]),t._v(" "),n("li",[t._v("它加载标准核心java类的扩展类，加载"),n("code",[t._v("JAVA_HOME/lib/ext")]),t._v("目录或系统属性"),n("code",[t._v("java.ext.dirs")]),t._v("指定的目录下的类库")])])]),t._v(" "),n("li",[t._v("sun.misc.Launcher$AppClassLoader应用（系统）类加载器\n"),n("ul",[n("li",[t._v("是扩展类加载器的孩子")]),t._v(" "),n("li",[t._v("加载类路径中我们编写的类（应用程序级别的类），加载classpath环境变量或命令参数"),n("code",[t._v("-cp")]),t._v("或"),n("code",[t._v("-classpath")]),t._v("指定的类")])])])]),t._v(" "),n("h4",{attrs:{id:"类加载器如何工作的"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#类加载器如何工作的"}},[t._v("#")]),t._v(" 类加载器如何工作的？")]),t._v(" "),n("p",[t._v("当jvm请求一个类时，类加载器将使用完全限定的类名尝试定位类，并将类定义加载到运行时。负责加载到运行时的方法是"),n("code",[t._v("java.lang.ClassLoader#loadClass(java.lang.String)")]),t._v("。如果类还未加载过，在父类加载器上调用\n"),n("code",[t._v("loadClass")]),t._v("方法，依次调用父类的"),n("code",[t._v("loadClass")]),t._v("方法直到bootstrap类。然后从bootstrap类开始加载指定类，如果找不到指定类，再由bootstrap的子类调用"),n("code",[t._v("java.net.URLClassLoader.findClass()")]),t._v("，依次直到当前类加载器。\n如果最终找不到会扔出"),n("code",[t._v("ClassNotFoundException")]),t._v("。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Class")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" resolve"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClassNotFoundException")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("synchronized")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getClassLoadingLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// First, check if the class has already been loaded")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Class")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("findLoadedClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" t0 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nanoTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                        c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                        c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("findBootstrapClassOrNull")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClassNotFoundException")]),t._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ClassNotFoundException thrown if class not found")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// from the non-null parent class loader")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If still not found, then invoke findClass in order")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// to find the class.")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" t1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("nanoTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("findClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this is the defining class loader; record the stats")]),t._v("\n                    sun"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("misc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PerfCounter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getParentDelegationTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" t0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    sun"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("misc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PerfCounter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFindClassTime")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addElapsedTimeFrom")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    sun"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("misc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PerfCounter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFindClasses")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("increment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resolve"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolveClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h4",{attrs:{id:"类加载器特性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#类加载器特性"}},[t._v("#")]),t._v(" 类加载器特性")]),t._v(" "),n("ul",[n("li",[t._v("委派模型"),n("br"),t._v("\n应用类加载器加载类或资源时，首先委托扩展类加载器加载，扩展类加载器再委托给bootstrap类加载器。只有当bootstrap类加载器和扩展类加载器不能加载到指定类时，应用类加载器才会自己去加载。")]),t._v(" "),n("li",[t._v("类的唯一性"),n("br"),t._v("\n向上委托父类查找的特性确保了类加载的唯一性。")]),t._v(" "),n("li",[t._v("可见性"),n("br"),t._v("\n子类加载器可以看到父类加载器加载的类。什么意思？"),n("br"),t._v("\n应用类加载器加载的类可以看到扩展类及bootstrap类加载器加载的类，反之则不成立。如A是应用类加载器加载，B是扩展类加载器加载，那么应用类加载器加载的其他类（如C类）可以看到A和B。\n但是扩展类加载器加载的D类只能看到B类。可以想象应用类加载器是最外面的圈圈，里面是扩展类加载器圈圈，再里面是bootstrap类加载器圈圈。最外面的圈圈可以看到里面圈圈加载的类，反之不然。")])]),t._v(" "),n("h4",{attrs:{id:"自定义类加载器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自定义类加载器"}},[t._v("#")]),t._v(" 自定义类加载器")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("使用场景")]),t._v(" "),n("ul",[n("li",[t._v("修改字节码，如织入agents")]),t._v(" "),n("li",[t._v("创建动态满足用户需求的类。比如，在JDBC里，在不同的驱动实现间切换是通过动态类加载完成的。")]),t._v(" "),n("li",[t._v("为相同包名和类名的类加载不同的字节码时，实现类版本控制机制。这个可以通过URL类加载器（通过URLs加载jars）或自定义类加载器实现。")]),t._v(" "),n("li",[t._v("浏览器，使用自定义类加载器从网站加载可执行内容。使用独立的类加载器从不同的网页加载applet。不同类加载器加载的相同名称applet被认为是不同的组件。")])])]),t._v(" "),n("li",[n("p",[t._v("实现自定义类加载器")]),t._v(" "),n("ul",[n("li",[t._v("继承抽象类"),n("code",[t._v("ClassLoader")]),t._v("并实现findClass方法以遵守委派模型")])])])]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CustomClassLoader")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClassLoader")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Class")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("findClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClassNotFoundException")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadClassFromFile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("defineClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadClassFromFile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" fileName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InputStream")]),t._v(" inputStream "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getClass")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getClassLoader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResourceAsStream")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                fileName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("File")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("separatorChar"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('".class"')]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ByteArrayOutputStream")]),t._v(" byteStream "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ByteArrayOutputStream")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" nextValue "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextValue "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" inputStream"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                byteStream"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextValue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IOException")]),t._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStackTrace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        buffer "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" byteStream"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("toByteArray")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" buffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h4",{attrs:{id:"类加载器核心api"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#类加载器核心api"}},[t._v("#")]),t._v(" 类加载器核心API")]),t._v(" "),n("ul",[n("li",[t._v("java.lang.ClassLoader#loadClass(java.lang.String, boolean)\n"),n("ul",[n("li",[t._v("当父类加载器未能加载到指定类时，当前类加载器将调用findClass方法")])])]),t._v(" "),n("li",[t._v("java.lang.ClassLoader#findClass\n"),n("ul",[n("li",[t._v("java.net.URLClassLoader#findClass")]),t._v(" "),n("li",[t._v("自定义类加载器实现findClass")]),t._v(" "),n("li",[t._v("最终调用final ClassLoader#defineClass。该方法扔出ClassFormatError")])])]),t._v(" "),n("li",[t._v("java.lang.ClassLoader#getParent\n"),n("ul",[n("li",[t._v("返回父类加载器")]),t._v(" "),n("li",[t._v("@CallerSensitive "),n("code",[t._v("sun.reflect.Reflection.getCallerClass")])])])]),t._v(" "),n("li",[t._v("java.lang.ClassLoader#getResource\n"),n("ul",[n("li",[t._v("查找指定名称的资源(音频，图片，文本等)")]),t._v(" "),n("li",[t._v("先委托父类查找资源，如果父类为null，则搜索内置到jvm的类加载器路径，如果都失败了，调用"),n("code",[t._v("java.lang.ClassLoader#findResource")]),t._v("查找。\n"),n("ul",[n("li",[t._v("java.net.URLClassLoader#findResource")]),t._v(" "),n("li",[t._v("指定的资源名称可以是类路径的相对路径或绝对路径")])])]),t._v(" "),n("li",[t._v("Java从类路径上加载资源")]),t._v(" "),n("li",[t._v("返回URL对象")]),t._v(" "),n("li",[t._v("Java中的资源加载与位置无关，只要设定了查找资源的环境，代码在哪运行无关紧要。")])])])]),t._v(" "),n("h4",{attrs:{id:"上下文类加载器-context-classloaders"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#上下文类加载器-context-classloaders"}},[t._v("#")]),t._v(" 上下文类加载器 Context Classloaders")]),t._v(" "),n("p",[t._v("当遇到bootstrap类加载器加载的核心类需要使用应用类加载器加载的类时（即加载对应用类加载器可见的类），委派模型的类加载机制不能满足这个需求。如在JNDI核心功能是在rt.jar里的\nbootstrap类实现的。但这些JNDI类可能需要加载独立厂商实现的JNDI提供程序（在应用程序类路径）。变通的方法是使用线程上下文类加载器。"),n("code",[t._v("java.lang.Thread#getContextClassLoader")]),t._v("，\n若没设置contextCLassLoader，则默认为父线程的类加载器上下文。")]),t._v(" "),n("ul",[n("li",[t._v("我的理解是JNDI核心类线程在调用应用代码线程时，暂时将应用代码的类加载器设置到核心类线程的上下文类加载器以加载应用资源\n类似如下代码")])]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The previous context ClassLoader")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClassLoader")]),t._v(" contextCL "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getContextClassLoader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Set my custom ClassLoader to make my classes accessible")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setContextClassLoader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("myCustomCL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Execute some code here that will be able to access to classes or resources from")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// my specific folders and/or jar files")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Restore the previous CL")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setContextClassLoader")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("contextCL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])])]),n("h3",{attrs:{id:"链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#链接"}},[t._v("#")]),t._v(" 链接")]),t._v(" "),n("p",[t._v("链接是获取类或接口并将它们组合到JVM的运行时状态中以便执行的过程。")]),t._v(" "),n("h2",{attrs:{id:"运行时数据区"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行时数据区"}},[t._v("#")]),t._v(" 运行时数据区")]),t._v(" "),n("h2",{attrs:{id:"执行引擎"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#执行引擎"}},[t._v("#")]),t._v(" 执行引擎")]),t._v(" "),n("p",[t._v("https://docs.oracle.com/javase/tutorial/essential/environment/sysprop.html")]),t._v(" "),n("p",[t._v("https://www.geeksforgeeks.org/jvm-works-jvm-architecture/")]),t._v(" "),n("h2",{attrs:{id:"参考"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://dzone.com/articles/jvm-architecture-explained",target:"_blank",rel:"noopener noreferrer"}},[t._v("The JVM Architecture Explained"),n("OutboundLink")],1),t._v(" "),n("a",{attrs:{href:"https://stackoverflow.com/questions/22626808/what-does-the-sun-reflect-callersensitive-annotation-mean",target:"_blank",rel:"noopener noreferrer"}},[t._v("@CallerSensitive"),n("OutboundLink")],1),n("br"),t._v(" "),n("a",{attrs:{href:"https://www.baeldung.com/java-classloaders",target:"_blank",rel:"noopener noreferrer"}},[t._v("Class Loaders in Java"),n("OutboundLink")],1),n("br"),t._v(" "),n("a",{attrs:{href:"https://stackoverflow.com/questions/39849690/when-to-use-thread-currentthread-getcontextclassloader-in-webapplications",target:"_blank",rel:"noopener noreferrer"}},[t._v("When to use Thread.currentThread().getContextClassLoader() in webapplications"),n("OutboundLink")],1),n("br"),t._v(" "),n("a",{attrs:{href:"https://www.oracle.com/java/technologies/faq-sun-packages.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Why Developers Should Not Write Programs That Call 'sun' Packages"),n("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);